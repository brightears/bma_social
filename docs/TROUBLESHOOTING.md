# Troubleshooting Guide

## Current Issues and Solutions

### 1. Frontend Login CORS Error

**Problem**: When trying to login on https://bma-social-frontend.onrender.com, getting CORS error:
```
Access to XMLHttpRequest at 'https://bma-social-api.onrender.com/api/v1/auth/login' 
from origin 'https://bma-social-frontend.onrender.com' has been blocked by CORS policy
```

**Current Configuration**:
- BACKEND_CORS_ORIGINS on Render is set to: `["https://bma-social-frontend.onrender.com","http://localhost:3000"]`

**Debugging Steps Taken**:
1. Verified API is running and responding
2. Tested with curl - API works but missing Access-Control-Allow-Origin header
3. Updated CORS origins in environment variables
4. Frontend and backend both deployed successfully

**Potential Solutions**:
1. Check if FastAPI CORS middleware is properly configured in `app/main.py`
2. Verify the BACKEND_CORS_ORIGINS is being parsed correctly
3. Temporarily add wildcard "*" to test if CORS is the only issue
4. Check Render logs for any CORS-related errors

### 2. API Response Validation Errors

**Problem**: Message sending works but returns 500 error due to Pydantic validation
```
3 validation errors for MessageResponse
id: Input should be a valid string [type=string_type, input_value=UUID('...'), input_type=UUID]
```

**Solution**: Update MessageResponse model to handle UUID to string conversion

### 3. Database Connection

**Problem**: Initial psycopg2 module not found error

**Solution**: 
- Modified `app/api/v1/dependencies/database.py` to convert DATABASE_URL to use asyncpg
- Database URL format: `postgresql+asyncpg://user:pass@host/dbname`

## Quick Fixes

### Reset Admin Password
```bash
# In Render shell for bma-social-api
cd backend
python scripts/init_db.py
```

### Check WhatsApp Webhook
```bash
# Test if messages are being received
curl https://bma-social-api.onrender.com/api/v1/webhooks/whatsapp
```

### Manual Database Connection
```bash
# In Render shell
python
>>> import os
>>> print(os.environ.get('DATABASE_URL'))
```

## Environment Variables Checklist

### Backend (bma-social-api)
- [x] DATABASE_URL - Auto-connected from Render PostgreSQL
- [x] REDIS_URL - Auto-connected from Render Redis
- [x] SECRET_KEY - Generated by Render
- [x] WHATSAPP_ACCESS_TOKEN - From Meta
- [x] WHATSAPP_PHONE_NUMBER_ID - From Meta
- [x] WHATSAPP_VERIFY_TOKEN - Set to match webhook
- [x] BACKEND_CORS_ORIGINS - JSON array of allowed origins

### Frontend (bma-social-frontend)
- [x] REACT_APP_API_URL - Set to https://bma-social-api.onrender.com

### Webhook Router
- [x] VERIFY_TOKEN - Must match Meta webhook config
- [x] ZONE_MONITOR_WEBHOOK_URL - https://syb-zone-monitor.onrender.com/webhook/whatsapp
- [x] BMA_SOCIAL_WEBHOOK_URL - https://bma-social-api.onrender.com/api/v1/webhooks/whatsapp